let sep_scripts={loaded_orders:[],shipping_providers:[],templates:[],tracking:null,order_status:[],construct(){jQuery(document).ready((async function(){await import("./modules/tracking.js").then(module=>{sep_scripts.tracking=new module.Tracking}),sep_scripts.set_event_listeners(),sep_scripts.load_template("order_details","order-details.html","templates/backend/components/"),sep_scripts.load_template("single_order","single-order.html","templates/backend/components/");const order_from_url=sep_scripts.get_order_from_url();empty(order_from_url)||sep_scripts.find_orders(order_from_url).then(()=>{sep_scripts.load_single_order(parseInt(order_from_url))})}))},set_event_listeners(){jQuery("#sep-order-search").on("click",e=>{e.preventDefault(),sep_scripts.find_orders()}),jQuery("#order-section-content").on("click",".sep-order-item button",e=>{let order_id=jQuery(e.currentTarget).data("order-id");sep_scripts.load_single_order(order_id),sep_scripts.update_url_to_single_order(order_id)}),jQuery("#order-section-content").on("keydown","#picklist_code_input",e=>{if(13!==e.which)return;let barcode=jQuery(e.currentTarget).val(),line_id=jQuery(`[data-product-sku="${barcode}"]`).data("line-id");sep_scripts.picklist_modify_quantity(line_id,"increase"),jQuery(e.currentTarget).val("")}),jQuery("#order-section-content").on("click","#edit_order",e=>{const order_id=sep_scripts.get_loaded_order_id();window.location=window.location.origin+window.location.pathname.replace("admin.php","post.php")+`?post=${order_id}&action=edit`}),jQuery("#order-section-content").on("click","#select-another-order",e=>{jQuery("#order-section-content").html(""),jQuery("#sep-order-search-input-container").show()}),jQuery("#order-section-content").on("click",".sep-remove-sp",e=>{const item_id=jQuery(e.currentTarget).parent().data("item-id"),order_id=sep_scripts.get_loaded_order_id();sep_scripts.remove_tracking_code(item_id,order_id)}),jQuery("#sep-save-shipping-provider").on("click",e=>{e.preventDefault(),sep_scripts.add_shipping_provider()}),jQuery("#sep_settings_page").on("click",".sep-remove-sp",e=>{e.preventDefault();let provider_id=jQuery(e.currentTarget).parent().data("item-id");sep_scripts.remove_shipping_provider(provider_id)}),jQuery("#sep_order_meta_box").on("click","#open-picklist-button",e=>{e.preventDefault();const order_id=sep_scripts.get_order_from_url("post");window.location=window.location.origin+window.location.pathname.replace("post.php","admin.php")+`?page=super-easy-picklist&order=${order_id}`})},set_single_event_listeners(){jQuery(".modify-product-quantity").on("click",e=>{let line_id=jQuery(e.currentTarget).data("line-id"),action=jQuery(e.currentTarget).data("action");sep_scripts.picklist_modify_quantity(line_id,action)}),jQuery("#pack-all").on("click",e=>{sep_scripts.picklist_pack_all()}),jQuery("#tracking-providers").on("change",e=>{this.tracking.maybe_display_tracking_input()}),jQuery("#finish-package").on("click",e=>{const order_index=jQuery(e.currentTarget).data("order-index");this.pack_order(order_index)}),jQuery("#order-status").on("change",e=>{this.update_status()})},load_template:async(template_id,file_name,path)=>(await sep_scripts.get_template(template_id,file_name,path).then((function(content){return sep_scripts.templates[template_id]=content,!0})),!1),get_template:async(template_id,file,subfolder="")=>empty(sep_scripts.templates[template_id])?response=await jQuery.get(window.sep_plugin_dir_url+subfolder+file,(function(data,textStatus,jqxhr){sep_scripts.templates[template_id]=data})):sep_scripts.templates[template_id],async find_orders(order_id){let loading_order_text=__("Loading orders...","sep"),send_data=new FormData;if(send_data.append("action","sep_ajax_orders"),empty(order_id)){let value=jQuery("#sep-order-search-input").val();send_data.append("do","get_orders"),send_data.append("search",value)}else send_data.append("do","get_single_order"),send_data.append("order_id",order_id),loading_order_text=__("Loading order %s","sep").replace("%s",order_id);jQuery("#order-section-content").html(loading_order_text);const ajax_response=await this.load_ajax(send_data),found_orders=this.get_ajax_success_answer(ajax_response);if(!empty(found_orders.orders))return this.loaded_orders=found_orders.orders,this.shipping_providers=found_orders.shipping_providers,this.order_status=found_orders.order_status,await sep_scripts.get_template("order_details","order-details.html","templates/backend/components/").then((function(content){if("object"==typeof found_orders.orders){var output="<h2>"+__("Found Orders","sep")+"</h2>";jQuery.each(found_orders.orders,(index,order)=>{var date_obj=new Date(order.date_created.date);output+=sep_scripts.add_templage_args(content,{order_number:order.id,name:order.billing.first_name+" "+order.billing.last_name,amount:order.total+" "+order.currency,date:date_obj.toDateString()})})}return jQuery("#order-section-content").html(output)}));sep_scripts.display_error(sep_scripts.get_ajax_error_answer(ajax_response),"#order-section-errors")},async load_single_order(order_id){for(const[index,order_obj]of Object.entries(this.loaded_orders))if(order_obj.id===order_id){var order_items=await sep_scripts.display_products_items_box(order_obj.line_items,index),tracking_input=await sep_scripts.get_tracking_input(order_obj.tracking),packed_products=await sep_scripts.display_packed_products_box(order_obj.tracking,index),status=await sep_scripts.display_status_box(order_obj);await sep_scripts.get_template("single_order","single-order.html","templates/backend/components/").then((function(content){if("object"==typeof order_obj){var output=sep_scripts.add_templage_args(content,{order_id:order_obj.id,billing_address:sep_scripts.get_order_address(order_obj),shipping_address:sep_scripts.get_order_address(order_obj,"shipping"),picklist_content:order_items,tracking_input:tracking_input,status_content:status,total_items:Object.keys(order_obj.line_items).length,packed_content:packed_products,order_index:index,order_title:__("Order","sep"),edit_order_text:__("Edit order","sep"),select_another_order_text:__("Select another order","sep"),billing_address_text:__("Billing address","sep"),shipping_address_text:__("Shipping address","sep"),picklist_title:__("Picklist","sep"),tracking_title:__("Shipping tracking","sep"),status_title:__("Order status","sep"),picklist_input_placeholder:__("Scan a product to add it to the picklist","sep"),items_packed_of_text:__("out of","sep"),items_packed_text:__("Items packed: ","sep"),pack_all_text:__("Pack all","sep"),finish_package_text:__("Finish package","sep"),packed_title:__("Packed items","sep")});jQuery("#order-section-content #picklist").html()}jQuery("#sep-order-search-input-container").hide(),jQuery("#order-section-content").html(output),sep_scripts.set_single_event_listeners(),sep_scripts.tracking.maybe_display_tracking_input()}))}},async display_packed_products_box(tracking_data,order_index){const packed_container_template=await sep_scripts.get_template("packed_container","packed-container.html","templates/backend/components/");var output="";if("object"!=typeof tracking_data)return __("Error while loading tracking data. Wrong format.","sep");if(!empty(tracking_data))for(const item of tracking_data){const items_html=await sep_scripts.get_tracked_products(item.items_packed,order_index);output+=sep_scripts.add_templage_args(packed_container_template,{items:items_html,tracking_code:item.sp_code,service_provider:empty(item.sp_name)?__("No shipping provider defined","sep"):item.sp_name,tracking_link:sep_scripts.get_tracking_link(item.sp_id,item.sp_code),date:empty(item.date_packed)?"":sep_scripts.convert_date(item.date_packed)})}return output},async get_tracked_products(items_packed,order_index=0){const list_item_template=await sep_scripts.get_template("list_products","list-products.html","templates/backend/components/");if(empty(items_packed))return!1;var output="";const order_items=sep_scripts.loaded_orders[order_index].line_items;return jQuery.each(items_packed,(index,packed)=>{output+=sep_scripts.add_templage_args(list_item_template,{line_id:packed.id,sku:order_items[packed.id].sku,product_id:order_items[packed.id].product_id,name:order_items[packed.id].name,quantity:packed.quant,total_quantity:order_items[packed.id].quantity,product_meta:sep_scripts.get_product_meta(order_items[packed.id].meta_data)})}),output},get_packed_count(line_id,order_index=0){var item_count=0,packed_items=jQuery(`#packed-container [data-line-id=${line_id}] .current-quantity`);if(!empty(packed_items)){for(item of packed_items){const quant=parseInt(jQuery(item).text());item_count+=quant}return item_count}const order_items=sep_scripts.loaded_orders[order_index].tracking;for(item of order_items)for(const[p_index,p_item]of Object.entries(item.items_packed))parseInt(line_id)===p_item.id&&(item_count+=p_item.quant);return item_count},async get_tracking_input(tracking_data){var template=await sep_scripts.get_template("tracking_input","tracking-input.html","templates/backend/components/");return"object"!=typeof tracking_data?__("Error while loading tracking data. Wrong format.","sep"):sep_scripts.add_templage_args(template,{tracking_providers:sep_scripts.get_tracking_providers()})},get_tracking_providers(){if(empty(sep_scripts.shipping_providers))return console.error("No shipping providers loaded"),!1;var output='<option value="none">'+__("None","sep")+"</option>";return jQuery.each(sep_scripts.shipping_providers,(index,item)=>{output+=`<option value="${item.id}">${item.name}</option>`}),output},async add_tracking_code(){var barcode=jQuery("#tracking-code-input").val(),sp_id=jQuery("#tracking-providers").val(),provider=this.get_shipping_provider_by_id(sp_id);provider=empty(provider.name)?provider:provider.name;var order_id=this.get_loaded_order_id();if(empty(barcode))return sep_scripts.display_error(__("No barcode given","sep"),"#tracking-codes-errors"),!1;var list_item_template=await sep_scripts.get_template("tracking_item","tracking-item.html","templates/backend/components/");let item=sep_scripts.add_templage_args(list_item_template,{link:barcode,name:provider,remove_text:'<i class="fa-solid fa-xmark"></i>'});jQuery("#current-tracking-codes-container").append(item);let send_data=new FormData;send_data.append("action","sep_ajax_orders"),send_data.append("do","add_tracking_code"),send_data.append("order_id",order_id),send_data.append("barcode",barcode),send_data.append("service_provider",sp_id);const ajax_response=await this.load_ajax(send_data),has_errors=this.get_ajax_error_answer(ajax_response);empty(has_errors)||sep_scripts.display_error(__("Updating the order failed: %s","sep").replace("%s",has_errors),"#tracking-codes-errors")},async remove_tracking_code(sp_id,order_id){jQuery(`#current-tracking-codes-container[data-item-id="${sp_id}"]`);let send_data=new FormData;send_data.append("action","sep_ajax_orders"),send_data.append("do","remove_tracking_code"),send_data.append("order_id",order_id),send_data.append("sp_id",sp_id);const ajax_response=await this.load_ajax(send_data),tracking=this.get_ajax_success_answer(ajax_response);empty(tracking)&&jQuery("#tracking-codes-errors").append(this.get_ajax_error_answer(ajax_response))},async add_shipping_provider(){let send_data=new FormData;send_data.append("action","sep_ajax_settings"),send_data.append("do","add_shipping_provider"),send_data.append("name",jQuery("#sep-add-shipping-provider-name").val()),send_data.append("link",jQuery("#sep-add-shipping-provider-link").val());const ajax_response=await this.load_ajax(send_data),providers=this.get_ajax_success_answer(ajax_response);if(empty(providers))return void jQuery("#sep-add-sp-errors").append(this.get_ajax_error_answer(ajax_response));if("object"!=typeof providers)return void jQuery("#sep-add-sp-errors").append(__("Error: Invalid shipping provider data received","sep"));jQuery("#sep-add-sp-errors").html("");const providers_html=await sep_scripts.list_all_shipping_providers(providers);jQuery("#sep-shipping-providers").html(providers_html)},async remove_shipping_provider(provider_id){let send_data=new FormData;send_data.append("action","sep_ajax_settings"),send_data.append("do","remove_shipping_provider"),send_data.append("id",provider_id),jQuery('.sep-tracking-item[data-item-id="'+provider_id+'"]').remove();const ajax_response=await this.load_ajax(send_data),removed=this.get_ajax_success_answer(ajax_response);empty(removed)?jQuery("#sep-add-sp-errors").append(this.get_ajax_error_answer(ajax_response)):jQuery("#sep-add-sp-errors").html("")},get_shipping_provider_by_id(id){const providers=this.shipping_providers;if(id=parseInt(id),empty(providers))return __("Error; No providers loaded.","sep");var output=!1;return jQuery.each(providers,(index,item)=>{item.id===id&&(output=item)}),output},get_tracking_link(sp_id,sp_code){if(empty(sp_code))return"";if(empty(sep_scripts.shipping_providers))return console.error("No shipping providers loaded"),!1;var tracking_link="";return jQuery.each(sep_scripts.shipping_providers,(index,item)=>{parseInt(sp_id)!==item.id||(tracking_link=item.link)}),empty(tracking_link)?(console.error("No tracking link found"),!1):tracking_link.replace("{tracking}",sp_code)},async list_all_shipping_providers(providers){var output="";if("object"!=typeof providers)return __("Error while loading providers. Wrong format.","sep");var template=await sep_scripts.get_template("tracking_item","tracking-item.html","templates/backend/components/");return jQuery.each(providers,(index,item)=>{output+=sep_scripts.add_templage_args(template,{id:item.id,link:item.link,name:item.name})}),output},async display_products_items_box(products,order_index=0){var output="";if("object"!=typeof products)return __("Error while loading products. Wrong format.","sep");var template=await sep_scripts.get_template("list_products","list-products.html","templates/backend/components/");return jQuery.each(products,(index,item)=>{output+=sep_scripts.add_templage_args(template,{line_id:item.id,sku:item.sku,product_id:item.product_id,name:item.name,quantity:sep_scripts.get_packed_count(item.id,order_index),total_quantity:item.quantity,product_meta:sep_scripts.get_product_meta(item.meta_data)})}),output},async display_status_box(order_obj){let status_options="";for(const[key,item_name]of Object.entries(this.order_status)){const selected=order_obj.status===key||"wc-"+order_obj.status===key?"selected":"";status_options+=`<option value="${key}" ${selected}>${item_name}</option>`}var template=await sep_scripts.get_template("status_box","status_box.html","templates/backend/components/");return sep_scripts.add_templage_args(template,{status_dropdown:status_options})},get_product_meta(meta){if("object"!=typeof meta)return __("Error while loading product meta. Wrong format.","sep");var output="";return jQuery.each(meta,(index,item)=>{empty(item.name)?console.log("No Meta name found for:",item):output=output+`${item.name} : ${item.value}`+"<br/>"}),output},get_order_address(order,type="billing"){if("object"!=typeof order||empty(order[type]))return __("Error while loading address. Wrong format or wrong type.","sep");let address=[];return empty(order[type].first_name)||address.push(`${order[type].first_name} ${order[type].last_name}`),empty(order[type].company)||address.push(order[type].company),empty(order[type].address_1)||address.push(order[type].address_1),empty(order[type].address_2)||address.push(order[type].address_2),empty(order[type].city)||address.push(`${order[type].postcode} ${order[type].city}`),empty(order[type].email)||address.push(order[type].email),empty(order[type].phone)||address.push(order[type].phone),address.join("<br/>")},get_ajax_success_answer(data,only_first=!0){return this.get_ajax_answer(data,"success",only_first)},get_ajax_error_answer(data,only_first=!0){return this.get_ajax_answer(data,"error",only_first)},get_ajax_system_error_answer(data,only_first=!0){return this.get_ajax_answer(data,"system_error",only_first)},display_error(message,field,replace=!1){replace?jQuery(field).html(message):jQuery(field).append(message)},get_ajax_answer(data,type,only_first=!0){try{var data_obj=JSON.parse(data)}catch(error){return void console.error(error)}if(void 0!==typeof data_obj[type])return only_first?data_obj[type][0]:data_obj[type]},load_ajax:async send_data=>await jQuery.ajax({url:window.ajaxurl,type:"POST",cache:!1,processData:!1,contentType:!1,data:send_data,success:function success(data){},error:function error(data){console.error(__("Failed to get a proper response from the ajax request.","sep"),data)}}),add_templage_args:(template_string,args={})=>(jQuery.each(args,(index,value)=>{template_string=template_string.replaceAll("{{"+index+"}}",value)}),template_string),picklist_modify_quantity(line_id,action="increase"){let current_quant=jQuery(`#picklist [data-line-id=${line_id}] .current-quantity`).text();current_quant=parseInt(current_quant);var new_quant="increase"===action?current_quant+1:current_quant-1;new_quant>=0&&jQuery(`#picklist [data-line-id=${line_id}] .current-quantity`).text(new_quant.toString()),sep_scripts.picklist_check_quantity(line_id),sep_scripts.update_picked_count(),jQuery(`#picklist [data-line-id=${line_id}]`).addClass("sep-updated")},picklist_pack_all(){jQuery("#picklist .sep-order-product-item").each((index,item)=>{const total=jQuery(item).find(".total-quantity").text(),current=jQuery(item).find(".current-quantity").text(),line_id=jQuery(item).data("line-id");total!==current&&(jQuery(item).find(".current-quantity").text(total),this.picklist_check_quantity(line_id),jQuery(`#picklist [data-line-id=${line_id}]`).addClass("sep-updated"))}),this.update_picked_count()},picklist_check_quantity(line_id){let current_quant=parseInt(jQuery(`#picklist [data-line-id=${line_id}] .current-quantity`).text()),total_quant=parseInt(jQuery(`#picklist [data-line-id=${line_id}] .total-quantity`).text());jQuery(`#picklist [data-line-id=${line_id}] .quantity`).removeClass("sep-valid"),jQuery(`#picklist [data-line-id=${line_id}] .quantity`).removeClass("sep-error"),current_quant===total_quant&&jQuery(`#picklist [data-line-id=${line_id}] .quantity`).addClass("sep-valid"),current_quant>total_quant&&jQuery(`#picklist [data-line-id=${line_id}] .quantity`).addClass("sep-error"),this.picklist_check_errors()},picklist_check_errors(){var total_errors=0;for(item of jQuery("#picklist .sep-order-product-item")){const current=parseInt(jQuery(item).find(".current-quantity").text()),total=parseInt(jQuery(item).find(".total-quantity").text());current>total&&total_errors++}0!==total_errors?sep_scripts.display_error(__("You have picked on %s positions to many items","sep").replace("%s",total_errors),"#pick-error",!0):jQuery("#pick-error").html("")},update_picked_count(){const packed=jQuery("#picklist .sep-order-product-item");var packed_count=0,total_packed=0;for(item of packed)packed_count+=parseInt(jQuery(item).find(".current-quantity").text()),total_packed+=parseInt(jQuery(item).find(".total-quantity").text());jQuery("#pick-info .items-packed").text(packed_count),jQuery("#pick-info .items-total").text(total_packed)},get_order_from_url(param_name="order"){const query=window.location.search,param=new URLSearchParams(query);return param.get(param_name)},get_loaded_order_id:()=>jQuery("#order-information").data("order-id"),update_url_to_single_order(order_id){let current_page=this.get_order_from_url("page");window.history.replaceState(null,null,`?page=${current_page}&order=${order_id}`)},async pack_order(order_index=0){const order_id=this.get_loaded_order_id();var items_send={};const sp_id=jQuery("#tracking-providers").val(),sp_code=jQuery("#tracking-code-input").val(),sp_name=sep_scripts.get_shipping_provider_by_id(sp_id).name;if(await jQuery("#picklist .sep-order-product-item").has(".sep-updated").each((index,item)=>{const current_quant=parseInt(jQuery(item).find(".current-quantity").text());if(0===current_quant)return;const total_quant=parseInt(jQuery(item).find(".total-quantity").text()),packed_class=current_quant===total_quant?"packed":"partly-packed",line_id=jQuery(item).data("line-id");items_send[index]={id:line_id,quant:sep_scripts.get_partly_packed_amount(current_quant,line_id)},jQuery(item).addClass(packed_class)}),"none"!==sp_id&&(empty(sp_id)||empty(sp_code)))return sep_scripts.display_error(__("No barcode or service provider given","sep"),"#tracking-codes-errors"),!1;if(empty(order_id))return sep_scripts.display_error(__("No order ID found","sep"),"#tracking-codes-errors"),!1;if(empty(items_send))return sep_scripts.display_error(__("No items found","sep"),"#tracking-codes-errors"),!1;let send_data=new FormData;send_data.append("action","sep_ajax_orders"),send_data.append("do","pack_order"),send_data.append("order_id",order_id),send_data.append("sp_id",sp_id),send_data.append("sp_code",sp_code),send_data.append("items",JSON.stringify(items_send));const ajax_response=await this.load_ajax(send_data),has_errors=this.get_ajax_error_answer(ajax_response);if(!empty(has_errors))return sep_scripts.display_error(__("Updating the order failed: %s","sep").replace("%s",has_errors),"#tracking-codes-errors"),!1;tracking_obj={items_packed:items_send,sp_code:sp_code,sp_id:sp_id,sp_name:sp_name,date_packed:"now"},sep_scripts.loaded_orders[order_index].tracking.push(tracking_obj);const reloaded_packed_products=await sep_scripts.display_packed_products_box(sep_scripts.loaded_orders[order_index].tracking,order_index);return jQuery("#packed-container").html(reloaded_packed_products),!0},async update_status(){const order_id=this.get_loaded_order_id(),new_status=jQuery("#order-status").val();let send_data=new FormData;send_data.append("action","sep_ajax_orders"),send_data.append("do","update_status"),send_data.append("order_id",order_id),send_data.append("status",new_status);const ajax_response=await this.load_ajax(send_data),has_errors=this.get_ajax_error_answer(ajax_response);if(!empty(has_errors))return sep_scripts.display_error(__("Updating the order failed: %s","sep").replace("%s",has_errors),"#status-errors"),!1},get_partly_packed_amount(total_packed,line_id){var packed_count=0;let packed=jQuery(`#packed-container [data-line-id=${line_id}] .current-quantity`);for(item of packed)packed_count+=parseInt(jQuery(item).text());return packed_count>0?total_packed-packed_count:total_packed},convert_date(timestamp){const packed_date=new Date(1e3*timestamp);return"now"===timestamp?__("Just now","sep"):wp.date.date(window.sep_date_format,packed_date)}};const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;function empty(value){return null===value||(void 0===value||0===value.length)}sep_scripts.construct();